{% from "components/iconlink.html" import iconLink %}
{% from "components/ratingstars.html" import ratingStarsIndicator %}

{% macro ccModalsHTML(grades) %}
<!--Info Modal-->
<div class="modal fade" id="modalInfoCollectionCourse" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Course info</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body px-4">
				<!--Term-->
				<div class="row">
					<div class="col-3">
						<span class="h5">Term</span>
					</div>
					<div class="col">
						<span class="term fs-5"></span>
						<div class="not-available text-warning-emphasis d-none">
							<i class="bi-exclamation-triangle-fill"></i>
							Course was not available in this term
						</div>
					</div>
				</div>
				<hr>
				<!--Course-->
				<div class="row">
					<div class="col-3">
						<span class="h5">Course</span>
					</div>
					<div class="col">
						<div class="code-link fs-5">
							<span class="emoji" title="Course emoji"></span>
							<a class="link icon-link icon-link-hover link-body-emphasis link-offset-1" href=""
								target="_blank" rel="noopener noreferrer">
								<span class="code font-monospace" title="Course code"></span>
								<i class="h5 bi bi-box-arrow-up-right mb-1"></i>
							</a>
						</div>
						<div class="code-custom d-none">
							<span class="fs-5 emoji" title="Course emoji"></span>
							<u class="fs-5 link link-body-emphasis link-offset-1"><span class="code font-monospace"
									title="Course code"></span></u>
							<span class="badge text-bg-secondary align-top my-1">Custom</span>
						</div>
						<div>
							<span class="name" title="Course name"></span>
						</div>
						<div>
							<span class="fw-bold">Units:</span>
							<span class="units"></span>
						</div>
						<div>
							<span class="fw-bold">Repeat for credit:</span>
							<span class="repeat"></span>
						</div>
						<div>
							<span class="fw-bold">Included in GPA:</span>
							<span class="countgpa"></span>
						</div>
						<div class="calendarurl">
							{{iconLink("", "Open in term calendar page", external=True)}}
						</div>
					</div>
				</div>
				<hr>
				<!--Rating-->
				<div class="row">
					<div class="col-3">
						<span class="h5">Rating</span>
					</div>
					<div class="col">
						<div class="rating fs-5 lh-sm">
							{% for i in range(1, 6) %}
							<span class="star-{{i}}">
								<i class="bi-star"></i>
								<i class="bi-star-half d-none"></i>
								<i class="bi-star-fill d-none"></i>
							</span>
							{% endfor %}
						</div>
					</div>
				</div>
				<hr>
				<!--Grade-->
				<div class="row">
					<div class="col-3">
						<span class="h5">Grade</span>
					</div>
					<div class="col">
						<span class="grade-symbol fs-5 font-monospace" title="Grade symbol">-</span>
						<div>
							<span class="fw-bold">Description:</span>
							<span class="grade-desc"></span>
						</div>
						<div>
							<span class="fw-bold">GPV:</span>
							<span class="grade-gpv"></span>
						</div>
						<div>
							<span class="fw-bold">Passed:</span>
							<span class="grade-passed"></span>
						</div>
						<div class="mt-2">
							<span class="fw-bold">Weighted GPV:</span>
							<span class="grade-weighted" title="GPV x Units" data-bs-toggle="tooltip"
								data-bs-placement="right"></span>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer d-flex justify-content-around">
				<button class="btn btn-primary" data-bs-dismiss="modal" onclick="modalEdit.modal('show')">
					<i class="bi-pencil-fill"></i>
					Edit
				</button>
			</div>
		</div>
	</div>
</div>

<!--Add Modal-->
<div class="modal fade" id="modalAddCourse" tabindex="-1" aria-hidden="true">
	<form id="formAddCollectionCourse" name="formAddCollectionCourse">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Add course to term</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body px-4 px-md-5">
					<!--Hidden fields-->
					<input type="number" name="collection_id" id="selectCollection" value="" readonly hidden>
					<input type="number" name="course_id" id="selectCourseId" value="" readonly hidden>
					<input type="checkbox" name="custom" id="selectCourseCustom" value="" readonly hidden>

					<div class="d-flex flex-row justify-content-center">
						<!--Subject code-->
						<input type="text"
							class="selectSubject form-control form-control-lg fs-4 font-monospace text-end border-2 border-secondary bg-body-tertiary text-body align-middle px-2 py-0"
							id="selectCourseSubject" minlength="2" maxlength="4" value="" placeholder="CODE"
							autocomplete="off">

						<!--Separator-->
						<div class="flex-shrink-1 d-flex flex-column justify-content-center">
							<span class="p-1 pt-0 m-0 fs-3 lh-1 align-middle">â€“</span>
						</div>

						<!--Course number-->
						<input type="text"
							class="selectNumber form-control form-control-lg fs-4 font-monospace text-begin border-2 border-secondary bg-body-tertiary text-body align-middle px-2 py-0"
							id="selectCourseNumber" maxlength="3" value="" placeholder="NUM" autocomplete="off"
							disabled>
					</div>

					<!--Course exists status-->
					<div id="selectCourseStatus" class="status invisible text-center mt-2 lh-1">
						<span class="success">
							<i class="bi-check-circle-fill text-success"></i>
						</span>
						<span class="warning">
							<i class="bi-exclamation-triangle-fill text-warning"></i>
						</span>
						<span class="error">
							<i class="bi-exclamation-octagon-fill text-danger"></i>
						</span>
						<small class="message"></small>
					</div>

					<div id="customCoursePrompt" class="text-center invisible">
						<a class="">Create custom course with this code</a>
					</div>

					<div id="customCourseFields" class="d-none mt-3">
						<h5>Custom course fields</h5>
						<div class="row mb-2">
							<label for="customCourseName" class="col-2 col-form-label">Name</label>
							<div class="col">
								<input type="text" id="customCourseName" name="name" class="form-control" value="">
							</div>
						</div>

						<div class="row mb-2">
							<label for="customCourseUnits" class="col-2 col-form-label">Units</label>
							<div class="col-4">
								<input type="number" id="customCourseUnits" name="units" class="form-control"
									value="3.00" min="0.00" max="99.99" step="0.01">
							</div>
						</div>

						<div class="row">
							<div class="col-1 py-2">
								<div class="form-check">
									<input class="form-check-input" type="checkbox" name="repeat"
										id="customCourseRepeat">
								</div>
							</div>
							<label class="col-5 col-form-label " for="customCourseRepeat">Repeat for
								credit</label>
							<div class="col-1 py-2">
								<div class="form-check">
									<input class="form-check-input" type="checkbox" name="nogpa"
										id="customCourseCountGPA" checked>
								</div>
							</div>
							<label class="col-5 col-form-label" for="customCourseCountGPA">Included in
								GPA</label>
						</div>
					</div>
				</div>
				<div class="modal-footer d-flex justify-content-around">
					<button id="selectCourseSubmit" type="submit" class="submit btn btn-primary" data-bs-dismiss="modal"
						disabled>
						Add Course
					</button>
					<button id="customCourseSubmit" type="submit" class="submit btn btn-primary d-none"
						data-bs-dismiss="modal" disabled>
						Add Custom Course
					</button>
				</div>
			</div>
		</div>
	</form>
</div>

<!--Edit Modal-->
<div class="modal fade" id="modalEditCollectionCourse" tabindex="-1" aria-hidden="true">
	<form id="formEditCollectionCourse" name="formEditCollectionCourse">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Edit course</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body px-5">
					<!--Course-->
					<div class="row mb-2">
						<label for="selectCoursePlaceholder" class="col-3 col-form-label">Course</label>
						<div class="col-9">
							<input type="hidden" id="selectCollectionCourse" name="id" value="">
							<input type="text" id="selectCoursePlaceholder" class="form-control col-9" value="" disabled
								readonly>
						</div>
					</div>
					<!--Term-->
					<div class="row mb-2">
						<input type="hidden" id="selectCollectionOld" value="">
						<label class="col-3 col-form-label" for="selectCollection">Term</label>
						<div class="col-9">
							<select class="form-select" aria-label="Select term" name="collection_id"
								id="selectCollection"></select>
						</div>
					</div>
					<!--Grade-->
					<div class="row">
						<label class="col-3 col-form-label" for="selectGrade">Grade</label>
						<div class="col-4">
							<select class="form-select" aria-label="Select grade" name="grade" id="selectGrade">
								<option value="0">-</option>
								{% for id, grade in grades.items() %}
								<option value="{{id}}">
									{{grade["symbol"]}}
								</option>
								{% endfor %}
							</select>
						</div>
						<label class="col-3 col-form-label" for="selectPassed">Passed</label>
						<div class="col-2 py-2">
							<div class="form-check">
								<input class="form-check-input" type="checkbox" name="passedCheck" id="selectPassed">
							</div>
						</div>
					</div>
					<!--Rating-->
					<div class="row mb-2">
						<label for="selectRating" class="col-3 col-form-label">Rating</label>
						<div class="col-6 pe-0 fs-3" id="selectRatingStars">
							{% for i in range(1, 6) %}<span class="star-{{i}} pe-1" db-rating="{{i}}"><i
									class="bi-star"></i><i class="bi-star-half d-none"></i><i
									class="bi-star-fill d-none"></i></span>{% endfor %}
						</div>
						<div class="col-3 ps-0">
							<select class="form-select" aria-label="Select rating" name="rating" id="selectRating">
								{% for i in range(6) %}
								<option value="{{i}}">
									{{i}} / 5
								</option>
								{% endfor %}
							</select>
						</div>
					</div>
				</div>
				<div class="modal-footer d-flex justify-content-between px-5">
					<button type="submit" method="DELETE" class="btn btn-danger m-0" data-bs-dismiss="modal">
						Remove
					</button>
					<button type="submit" method="PUT" class="btn btn-primary m-0" data-bs-dismiss="modal">
						Save changes
					</button>
				</div>
			</div>
		</div>
	</form>
</div>
{% endmacro %}

{% macro ccModalsScripts() %}
<script>
	const modalInfo = $("#modalInfoCollectionCourse")
	const modalAdd = $("#modalAddCourse")
	const formAdd = $("#formAddCollectionCourse")
	const modalEdit = $("#modalEditCollectionCourse")
	const formEdit = $("#formEditCollectionCourse")

	//
	// UTIL FUNCS
	//

	function formAddCustomOff() {
		$("#selectCourseCustom").prop("checked", false);
		$("#customCoursePrompt").addClass("invisible")
		$("#customCourseFields").addClass("d-none")
		$("#customCourseSubmit").addClass("d-none")
		$("#selectCourseSubmit").removeClass("d-none")
		$("#selectCourseSubmit").prop("disabled", true)
	}

	function formAddCustomOn() {
		$("#selectCourseCustom").prop("checked", true);
		$("#customCoursePrompt").addClass("invisible")
		$("#customCourseFields").removeClass("d-none")
		$("#selectCourseSubmit").addClass("d-none")
		$("#customCourseSubmit").removeClass("d-none")
		$("#customCourseSubmit").prop("disabled", false)

		$("#customCourseName").val("")
		$("#customCourseUnits").val(3.00)
		$("#customCourseRepeat").prop("checked", false)
		$("#customCourseCountGPA").prop("checked", true)
	}

	function selectCourseStatus(status, message = "") {
		$("#selectCourseStatus").addClass("invisible")
		$("#selectCourseStatus .message").html("...")
		if (status) {
			$("#selectCourseStatus").children("span").hide()
			$("#selectCourseStatus ." + status).show()
			$("#selectCourseStatus .message").html(message)
			$("#selectCourseStatus").removeClass("invisible")
		}
	}

	function checkCourse() {
		addCollectionCourseCheck(
			formAdd.find("#selectCollection").val(),
			$("#selectCourseSubject").val(),
			$("#selectCourseNumber").val(),
			(response) => {
				if (response.error) {
					$("#selectCourseId").val("")
					$("#selectCourseSubmit").prop("disabled", true)
					selectCourseStatus("error", response.error)
				} else {
					if (response.success) {
						selectCourseStatus("success", response.success)
						$("#customCoursePrompt").addClass("invisible")
					} else {
						let warnings = ""
						for (let w of response.warnings)
							warnings += w + "<br>"
						selectCourseStatus("warning", warnings)
					}
					if (response.course_id == null) {
						$("#customCoursePrompt").removeClass("invisible")
					} else {
						$("#selectCourseId").val(response.course_id)
						$("#selectCourseSubmit").prop("disabled", false)
					}
				}
			}
		)
	}

	function updateModals(cc, collection, collections) {
		modalInfo.find(".name").text("Loading...")
		modalInfo.find(".link").prop("href", "")
		modalInfo.find(".repeat").text("Loading...")
		modalInfo.find(".countgpa").text("Loading...")
		modalInfo.find(".not-available").addClass("d-none")

		modalInfo.find(".term").text(collection.term_name)
		modalInfo.find(".emoji").html("&#" + (cc.course_emoji ? cc.course_emoji : DEFAULT_EMOJI))
		modalInfo.find(".code").text(cc.course_code)
		modalInfo.find(".units").text(cc.course_units.toFixed(2))
		setRatingIndicator(modalInfo.find(".rating"), cc.rating ? Math.round(cc.rating / 20) : 0)
		modalInfo.find(".rating").val(cc.rating ? Math.round(cc.rating / 20) : 0)
		if (cc.calendar_url) {
			modalInfo.find(".calendarurl a").prop("href", cc.calendar_url)
			modalInfo.find(".calendarurl").removeClass("d-none")
		} else {
			modalInfo.find(".calendarurl a").prop("href", "")
			modalInfo.find(".calendarurl").addClass("d-none")
		}

		if (cc.custom) {
			modalInfo.find(".code-custom").removeClass("d-none")
			modalInfo.find(".code-link").addClass("d-none")
		} else {
			modalInfo.find(".code-custom").addClass("d-none")
			modalInfo.find(".code-link").removeClass("d-none")
		}

		getCourse(cc.id, (course) => {
			modalInfo.find(".name").text(course.name)
			modalInfo.find(".link").prop("href", course.url)
			modalInfo.find(".repeat").text(course.repeat ? "Yes" : "No")
			modalInfo.find(".countgpa").text(course.countgpa ? "Yes" : "No")
			if (!cc.custom && !cc.calendar_available)
				modalInfo.find(".not-available").removeClass("d-none")
		})

		if (cc.grade_id) {
			const grade = grades[cc.grade_id]
			modalInfo.find(".grade-symbol").text(grade.symbol)
			modalInfo.find(".grade-desc").text(grade.desc)
			modalInfo.find(".grade-passed").text(grade.passed ? "Yes" : "No")
			if (grade.gpv != null) {
				modalInfo.find(".grade-gpv").text(grade.gpv.toFixed(2))
				modalInfo.find(".grade-weighted").text((grade.gpv * cc.course_units).toFixed(2))
			} else {
				modalInfo.find(".grade-gpv").text("N/A")
				modalInfo.find(".grade-weighted").text("N/A")
			}
		} else {
			modalInfo.find(".grade-symbol").text("-")
			modalInfo.find(".grade-desc").text("")
			modalInfo.find(".grade-gpv").text("")
			modalInfo.find(".grade-passed").text("")
			modalInfo.find(".grade-weighted").text("")
		}

		formEdit.find("#selectCollectionCourse").val(cc.id)
		formEdit.find("#selectCoursePlaceholder").val(cc.course_code)
		formEdit.find("#selectGrade").val(cc.grade_id ? cc.grade_id : 0)
		formEdit.find("#selectPassed").prop("checked", cc.passed ? cc.passed : false)
		setRatingIndicator(formEdit.find("#selectRatingStars"), cc.rating ? Math.round(cc.rating / 20) : null)
		formEdit.find("#selectRating").val(cc.rating ? Math.round(cc.rating / 20) : 0)
		if (collection.transfer || !collection.term.prev) {
			formEdit.find("#selectRatingStars").addClass("text-muted")
			formEdit.find("#selectRatingStars").prop("title", "Rating cannot be added for course in this term")
			formEdit.find("#selectRating").prop("disabled", true)
		} else {
			formEdit.find("#selectRatingStars").removeClass("text-muted")
			formEdit.find("#selectRating").prop("disabled", false)
		}

		$("#formEditCollectionCourse #selectCollection").empty()
		for (let c of collections) {
			$("#formEditCollectionCourse #selectCollection").append(
				$("<option>", {
					value: c.id,
					text: c.term_name
				})
			)
		}
		formEdit.find("#selectCollection").val(collection.id)
		formEdit.find("#selectCollectionOld").val(collection.id)
	}

	function setRatingIndicator(element, rating) {
		for (let i = 1; i <= 5; i++) {
			let star = element.find(".star-" + i)
			if (i <= rating) {
				star.find(".bi-star").addClass("d-none")
				star.find(".bi-star-half").addClass("d-none")
				star.find(".bi-star-fill").removeClass("d-none")
			} else if (i <= rating + 0.5) {
				star.find(".bi-star").addClass("d-none")
				star.find(".bi-star-half").removeClass("d-none")
				star.find(".bi-star-fill").addClass("d-none")
			} else {
				star.find(".bi-star").removeClass("d-none")
				star.find(".bi-star-half").addClass("d-none")
				star.find(".bi-star-fill").addClass("d-none")
			}
		}
		element.prop("title", rating ? rating + " / 5 stars" : "Rating not set")
	}

	//
	// REQUEST FUNCS
	//

	function getCourse(collection_course_id, callback) {
		ajax("GET", "me/courses/" + collection_course_id + "/course", {}, callback)
	}

	function addCollectionCourseCheck(collection_id, code, number, callback) {
		ajax("POST", "me/courses/check",
			{
				collection_id: collection_id,
				subject_code: code,
				course_number: number
			},
			callback
		)
	}

	function addCollectionCourse(data, callback) {
		ajax("POST", "me/courses",
			data,
			callback
		)
	}

	function putCollectionCourse(data, callback, onerror = displayError) {
		ajax("PUT", "me/courses", data, callback, onerror)
	}

	function delCollectionCourse(id, callback) {
		ajax("DELETE", "me/courses/" + id, {}, callback)
	}

	//
	// EVENTS
	//

	// On modal starts to show
	modalAdd.on("show.bs.modal", () => {
		// Clear form inputs
		formAdd.find(".selectSubject").val("")
		formAdd.find(".selectNumber").val("")

		// Hide status
		selectCourseStatus()

		formAddCustomOff()
	})

	// On modal is shown - move focus to input
	modalAdd.on("shown.bs.modal", () => {
		formAdd.find(".selectSubject").focus()
	})


	// On key up inside subject selection
	formAdd.find("#selectCourseSubject").on("keyup", function (e) {
		// Remove special characters
		$(this).val($(this).val().replace(/[^a-zA-Z]/g, "").toUpperCase())

		if ($(this).val().length < $(this).attr("minLength")) {
			formAdd.find(".selectNumber").prop("disabled", true)
			formAddCustomOff()
			selectCourseStatus()
		} else {
			formAdd.find(".selectNumber").prop("disabled", false)
			if (formAdd.find(".selectNumber").val().length == formAdd.find(".selectNumber").attr("maxLength"))
				checkCourse()
		}

		// Move focus to number selection if max length is reached
		if ($(this).val().length == $(this).attr("maxLength"))
			formAdd.find(".selectNumber").focus()
	})

	// On key up inside number selection
	formAdd.find("#selectCourseNumber").on("keydown", function (e) {
		// If pressing backspace and the value is empty, move focus to subject selection
		if ($(this).val().length == 0 && e.keyCode == 8)
			formAdd.find(".selectSubject").focus()
	})

	// On key down inside number selection
	formAdd.find("#selectCourseNumber").on("keyup", function (e) {
		// Remove special characters
		$(this).val($(this).val().replace(/[^a-zA-Z0-9]/g, "").toUpperCase())

		// Check course if length is complete
		if ($(this).val().length == $(this).attr("maxLength")) {
			checkCourse()
		} else {
			formAddCustomOff()
			selectCourseStatus()
		}
	})

	formAdd.find("#customCoursePrompt").on("click", () => {
		formAddCustomOn()
	})

	formAdd.on("submit", (event) => {
		event.preventDefault()
		event.stopImmediatePropagation()

		data = { collection_id: formAdd.find("#selectCollection").val() }

		if (formAdd.find("#selectCourseCustom").prop("checked")) {
			// Custom course
			data.custom = true
			data.subject_code = formAdd.find("#selectCourseSubject").val()
			data.number = formAdd.find("#selectCourseNumber").val()
			data.name = formAdd.find("#customCourseName").val()
			data.units = parseFloat(formAdd.find("#customCourseUnits").val())
			data.repeat = formAdd.find("#customCourseRepeat").prop("checked")
			data.countgpa = formAdd.find("#customCourseCountGPA").prop("checked")
		} else {
			// Existing course
			data.custom = false
			data.course_id = formAdd.find("#selectCourseId").val()
		}
		addCollectionCourse(data, (response) => {
			alert("success", "Course added!")
			for (let w of response.warnings)
				alert("warning", w)
			if (typeof getUpdateCollection !== "undefined")
				getUpdateCollection(formAdd.find("#selectCollection").val())
			if (typeof ccAfterUpdate !== "undefined")
				ccAfterUpdate()
		})

	})

	formEdit.find("#selectGrade").on("change", function () {
		formEdit.find("#selectPassed").prop("checked",
			grades[$(this).val()] ? grades[$(this).val()].passed : false
		)
	})

	formEdit.find("#selectRatingStars").on("click", "span", function () {
		if (formEdit.find("#selectRating").prop("disabled") == false) {
			let rating = parseInt($(this).attr("db-rating"))
			setRatingIndicator(formEdit.find("#selectRatingStars"), rating)
			formEdit.find("#selectRating").val(rating)
		}
	})

	formEdit.find("#selectRatingStars").on("mouseover", "span", function () {
		if (formEdit.find("#selectRating").prop("disabled") == false) {
			let rating = parseInt($(this).attr("db-rating"))
			setRatingIndicator(formEdit.find("#selectRatingStars"), rating)
			formEdit.find("#selectRating").val(rating)
		}
	})

	formEdit.find("#selectRating").on("change", function () {
		let rating = parseInt($(this).val())
		setRatingIndicator(formEdit.find("#selectRatingStars"), rating)
	})

	formEdit.on("submit", (event) => {
		event.preventDefault()
		event.stopImmediatePropagation()

		let form = $(event.target)
		let method = $(event.originalEvent.submitter).attr("method")

		if (method == "PUT") {
			data = {
				id: form.find("#selectCollectionCourse").val(),
				collection_id: form.find("#selectCollection").val(),
				grade_id: form.find("#selectGrade").val(),
				passed: form.find("#selectPassed").prop("checked")
			}
			if (form.find("#selectRating").prop("disabled") == false)
				data.rating = parseInt(form.find("#selectRating").val()) * 20
			putCollectionCourse(data, () => {
				alert("success", "Course updated!")
				if (typeof getUpdateCollection !== "undefined") {
					getUpdateCollection(form.find("#selectCollection").val())
					if (form.find("#selectCollectionOld").val() != form.find("#selectCollection").val())
						getUpdateCollection(form.find("#selectCollectionOld").val(), false)
				}
				if (typeof ccAfterUpdate !== "undefined")
					ccAfterUpdate()
			})
		} else if (method == "DELETE") {
			delCollectionCourse(form.find("#selectCollectionCourse").val(), () => {
				alert("success", "Course removed!")
				if (typeof getUpdateCollection !== "undefined")
					getUpdateCollection(form.find("#selectCollectionOld").val())
				if (typeof ccAfterUpdate !== "undefined")
					ccAfterUpdate()
			})
		}
	})
</script>
{% endmacro %}