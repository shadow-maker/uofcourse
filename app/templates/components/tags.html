<!--Modal edit tags-->
<div class="modal fade" id="modalEditTags" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Edit tags</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="tag-items"></div>
				<div class="d-flex justify-content-center">
					<button type="button" class="btn btn-sm btn-secondary" onclick="addTag()">
						<i class="bi-plus-lg"></i> Add tag
					</button>
				</div>
			</div>
			<div class="modal-footer d-flex justify-content-around">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				<button id="modalEditTagsSubmit" type="submit" class="btn btn-primary" onclick="tagExecuteChanges()">Save changes</button>
			</div>
		</div>
	</div>
</div>

<!--Tags drawer offcanvas-->
<div class="offcanvas offcanvas-end" tabindex="-1" id="tagsDrawer" aria-labelledby="Tags Drawer">
	<div class="offcanvas-header px-lg-4">
		<h3 class="m-0">Tags drawer</h3>
		<button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
	</div>
	<div class="offcanvas-body px-lg-4"></div>
	<div class="offcanvas-footer py-3 d-flex justify-content-center">
		<button class="btn btn-secondary mx-2 d-sm-none" data-bs-dismiss="offcanvas" aria-label="Close">
			<i class="bi-x-lg"></i>
			Close
		</button>
		<button class="btn btn-secondary mx-2" data-bs-toggle="modal" data-bs-target="#modalEditTags">
			<i class="bi-pencil"></i>
			Edit tags
		</button>
	</div>
</div>

<style>
@media (max-width: 992px) {
	#tagsDrawer {
		width: 300px;
	}
}

@media (min-width: 768px) {
	#tagsDrawer .list-group-item .remove {
		opacity: 0;
	}
	#tagsDrawer .list-group-item:hover .remove {
		opacity: 1;
	}
}
</style>

<!--Tags scripts-->
<script>
var tagsCallback = () => {}

var tagIndex = 0

function colorToHex(color) {
	return ("000000" + color.toString(16)).slice(-6)
}

// REQUEST FUNCS

function requestTag(subpath, method, data, callback) {
	$.ajax({
		url: "/api/tags" + subpath,
		method: method,
		data: data,
		success: (response) => {
			callback(response)
		},
		error: (response) => {
			displayError(response)
		}
	})
}

function requestEditTag(id, data, callback) {
	requestTag("/" + id, "PUT", data, callback)
}

function requestDeleteTag(id, callback) {
	requestTag("/" + id, "DELETE", {}, callback)
}

function requestTagCourses(id, callback) {
	requestTag("/" + id + "/courses", "GET", {}, callback)
}

function requestCourseTags(id, callback) {
	requestTag("/course/" + id, "GET", {}, callback)
}

function requestToggleTag(tagId, courseId) {
	requestTag("/" + tagId + "/course/" + courseId, "PUT", {}, (response) => {
		alert("success", response.success)
		loadTagsDrawer()
		tagsCallback()
	})
}

// TAG EDIT FUNCS

function addTag() {
	const color = Object.keys(COLORS)[Math.floor(Math.random() * Object.keys(COLORS).length)]
	$("#modalEditTags .tag-items").append(`
		<div id="tag-edit-` + tagIndex +`" class="">
		<div class="inputs row">
			<div class="col-11">
				<div class="input-group">
					<span class="tag-color-indicator input-group-text" style="color: #` + colorToHex(COLORS[color]) + `;">
						<i class="bi-circle-fill"></i>
					</span>
					<select class="tag-color form-select" name="color" onchange="tagUpdateColor(` + tagIndex +`)" >
						` + colorOptions(COLORS[color]) + `
					</select>
					<input type="text" class="tag-name form-control w-25" name="name" placeholder="Tag name" aria-label="Tag name">
				</div>
			</div>
			<div class="col-1 ps-0">
				<button class="btn px-0" type="button" title="Delete tag" onclick="tagDelete(` + tagIndex +`)">
					<i class="h5 bi-trash text-danger"></i>
				</button>
			</div>
		</div>
		<hr class="my-3">
		</div>
	`)
	tagIndex++
}

function tagDelete(index) {
	$("#tag-edit-" + index).remove()
}

function tagRemove(index) {
	$("#tag-edit-" + index).attr("db-delete", "true")
	$("#tag-edit-" + index + " .inputs").hide()
	$("#tag-edit-" + index + " .deleted").show()
}

function tagUndoRemove(index) {
	$("#tag-edit-" + index).attr("db-delete", "false")
	$("#tag-edit-" + index + " .inputs").show()
	$("#tag-edit-" + index + " .deleted").hide()
}

function tagUpdateColor(index) {
	const item = $("#tag-edit-" + index)
	item.find(".tag-color-indicator").css("color", "#" +  colorToHex(parseInt(item.find(".tag-color").val())))
}

function tagExecuteChanges() {
	$("#modalEditTags").modal("hide")
	var data = {}
	var callback = (response) => {
		if (response.success)
			alert("success", response.success)
	}

	$("#modalEditTags .tag-items").children().each(function(i) {
		if (i == $("#modalEditTags .tag-items").length - 1) {
			callback = (data) => {
				if (data.success)
					alert("success", data.success)
				requestTag("", "GET", {}, (response) => {
					userTags = response.tags
					loadTagsDrawer()
					tagsCallback()
				})
			}
		}

		data = {}
		tag_id = $(this).attr("db-id")

		var existing = null
	
		for (let tag of userTags)
			if (tag.id == tag_id) {
				existing = tag
				break
			}

		if (existing) { // Existing tag
			if ($(this).attr("db-delete") == "true") { // Delete tag
				requestDeleteTag(tag_id, callback)
			} else if (existing.deletable) { // Update tag
				data.name = $(this).find(".tag-name").val()
				data.color = parseInt($(this).find(".tag-color").val())
				if (data.name.length > 0 && (data.name != existing.name || data.color != existing.color))
					requestEditTag(tag_id, data, callback)
			}
		} else { // New tag
			data.name = $(this).find(".tag-name").val()
			data.color = parseInt($(this).find(".tag-color").val())
			if (data.name.length > 0)
				requestTag("", "POST", data, callback)
		}
	})
}

// EXTRA

function colorOptions(tagColor) {
	var html = ""

	var colorFound = false

	for (let color in COLORS) {
		if (COLORS[color] == tagColor)
			colorFound = true
	
		html += `
			<option value='` + COLORS[color] +`' `  + (COLORS[color] == tagColor ? `selected` : ``) + `>
				` + color.charAt(0).toUpperCase() + color.slice(1) +`
			</option>
		`
	}

	if (!colorFound) {
		html = `
			<option value='` + tagColor +`' selected>
				#` + colorToHex(tagColor) +`
			</option>
		` + html
	}

	return html
}

function loadEditTagsModal() {
	tagIndex = 0

	$("#modalEditTags .tag-items").empty()
	for (let tag of userTags) {
		$("#modalEditTags .tag-items").append(`
			<div id="tag-edit-` + tagIndex +`" db-id=` + tag.id +` db-delete="false">
				<div class="inputs row">
					<div class="col-11">
						<div class="input-group">
							<span class="tag-color-indicator input-group-text" style="color: #` + colorToHex(tag.color) + `;">
								<i class="bi-circle-fill"></i>
							</span>
							<select class="tag-color form-select" name="color" onchange="tagUpdateColor(` + tagIndex +`)" ` + (tag.deletable ? `` : `disabled title="Tag cannot be edited"`) + `>
								` + colorOptions(tag.color) + `
							</select>
							<input type="text" class="tag-name form-control w-25" name="name" placeholder="Tag name" aria-label="Tag name" value="` + tag.name + `" ` + (tag.deletable ? `` : `readonly title="Tag cannot be edited"`) + `>
						</div>
					</div>
					<div class="col-1 ps-0">
						<button class="btn px-0" type="button" ` + (tag.deletable ? `title="Delete tag" onclick="tagRemove(` + tagIndex +`)"` : `disabled title="Tag cannot be deleted"`) + `>
							<i class="h5 bi-trash text-danger"></i>
						</button>
					</div>
				</div>
				<div class="deleted row">
					<div class="col-11">
						<div class="input-group">
							<input type="text" class="form-control fst-italic" placeholder="Tag deleted" aria-label="Tag deleted" value="Deleted" disabled>
						</div>
					</div>
					<div class="col-1 ps-0">
						<button class="btn px-0" type="button" title="Undo delete tag" onclick="tagUndoRemove(` + tagIndex +`)">
							<i class="h5 bi-arrow-counterclockwise"></i>
						</button>
					</div>
				</div>
				<hr class="my-3">
			</div>
		`)
		$("#tag-edit-" + tagIndex + " .deleted").hide()
		tagIndex++
	}
}

function loadTagsDrawer() {
	const container = $("#tagsDrawer .offcanvas-body")
	container.empty()
	tagIndex = 0
	for (let tag of userTags) {
		let tagItem = $("<div class='list-group mb-3'></div>")
		let emoji = ""
		if (tag.emoji) {
			emoji = `
				<span class="tag-emoji">
					&#` + tag.emoji + `;
				</span>
			`
		} else {
			emoji = `
				<span class="tag-color-indicator" style="color: #` + colorToHex(tag.color) + `;">
					<i class="bi-circle-fill"></i>
				</span>
			`
		}
		tagItem.append(`
			<div class="list-group-item fs-5 bg-light d-flex justify-content-between align-items-center">
				<span class="name">
					` + emoji +` ` + tag.name.charAt(0).toUpperCase() + tag.name.slice(1) + `
				</span>
				<span class="count badge bg-primary rounded-pill" title="Courses count"></span>
			</div>
		`)
		tagItem.append(`
			<div class="loading list-group-item fst-italic">Loading...</div>
		`)
		container.append(tagItem)

		requestTagCourses(tag.id, (data) => {
			tagItem.find(".loading").remove()
			tagItem.find(".count").text(data.courses.length)
			for (let course of data.courses) {
				tagItem.append(`
					<div class="list-group-item list-group-item-action p-0 d-flex justify-content-between">
						<a class="flex-grow-1 px-4 py-2 text-body text-decoration-none" href="` + course.url +`">
							<span class="emoji">&#` + (course.emoji ? course.emoji : DEFAULT_EMOJI) +`</span>
							<span class="code font-monospace">` + course.code +`</span>	
						</a>
						<span class="remove px-4 py-2 text-body" href="" onclick="requestToggleTag(` + tag.id + `,` + course.id + `)" style="cursor: pointer;" title="Remove course from tag">
							<i class="bi-x-lg"></i>
						</span>
					</div>
				`)
			}
		})
	}
}

// EVENTS

// On tags modal starts to show
$("#modalEditTags").on("show.bs.modal", loadEditTagsModal)

// On tags drawer starts to show
$("#tagsDrawer").on("show.bs.offcanvas", (e) => {
	if (isAuth) {
		loadTagsDrawer()
	} else {
		e.preventDefault()
		alert("warning", "You must be logged in to view your tagged courses")
	}
})

$("#tagsDrawer .list-group-item .remove").on("click", (e) => {
	e.preventDefault()
})

// INIT

$(document).ready(() => {
	if (!isAuth) {
		userTags = []
	}
	else {
		requestTag("", "GET", {}, (data) => {
			userTags = data.tags
		})
	}
})

function tagsInit(callback = () => {}) {
	tagsCallback = callback

	if (!isAuth) {
		userTags = []
	}
	else {
		requestTag("", "GET", {}, (data) => {
			userTags = data.tags
			tagsCallback()
		})
	}
}
</script>
